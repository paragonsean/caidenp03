#!/usr/bin/env bash
set -euo pipefail

# 12 producer/consumer test cases
producers=(1 4 16  1 4 16  1 4 16   1 4 16)
consumers=(1 1  1  2 2 2  4 4 4  16 16 16)

# The set of durations to try for each p/c combination
durations=(
  0.00001 0.00002 0.00003 0.00004 0.00005 0.00006 0.00007 0.00008 0.00009
  0.00011  0.00012  0.00013  0.00014  0.00015  0.00016  0.00017  0.00018 
   0.00019  0.00021  0.00022 0.00023 0.00024 0.00025 0.00026 0.00027 0.00028 
   0.00029 0.00031 0.00032 0.00033 0.00034 0.00035 0.00036  0.00037 0.00038 
   0.00039 0.00040 0.00041 0.00042 0.00043 0.00044 0.00045 0.00046 0.00047
   0.00048 0.00049 0.00050 0.00051 0.00051 0.00052 0.00053 0.00054 0.00055 
   0.00056 0.00057 0.00058 0.00059 0.0006  0.0007 0.00071 0.00071 0.00072 
   0.00073 0.00074 0.00075  0.00076 0.00077 0.00078 0.00079 0.0008 0.00081
   0.00082 0.00083 0.00084 0.00085 0.00086 0.00087 0.00088 0.00089 0.0009
   0.001 0.0021   0.0022  0.0023  0.0024  0.0025  0.0026  0.0027  0.0028  0.0029
    0.0031  0.0032  0.0033  0.0034  0.0035  0.0036  0.0037  0.0037  0.0038 
     0.0039  0.0041  0.0042  0.0043  0.0044  0.0045  0.0046  0.0047  0.0048
      0.0049  0.0051  0.0052  0.0053  0.0054  0.0055  0.0056  0.0057  0.0058 
       0.0059  0.006  0.007  0.008  0.009   0.01  0.021  0.0031  0.0041  0.0051
        0.0061  0.0071  0.0081  0.0091  0.01  0.011  0.012 0.013  0.014 0.015 0.016 0.017 0.018 0.019
        0.11 0.12 0.13 0.14 0.15 0.16 0.17 0.18 0.19 0.21 0.22 0.23 0.24 0.25 0.26 0.27 0.28 0.29 
        0.31 0.32  0.33 0.34 0.35 0.36 0.37 0.38 0.39 0.41 0.42 0.43 0.44 0.45 0.46 0.47 0.48 0.49 
        0.5 0.51 0.52 0.53 0.54 0.55 0.56 0.57 0.58 0.59 0.6 0.61 0.62 0.63 0.64 0.65 0.66 0.67 0.68 0.69 
        0.7 0.71 0.72 0.73 0.74 0.75 0.76 0.77 0.78 0.79 0.8 0.81 0.91 0.92 0.93 0.94 0.95 0.96 0.97 0.98 0.99
     1 2 3 4 5

)

# Prepare logs directory
mkdir -p logs

# Global test-case counter
tc=0

# For each (p,c)...
for idx in "${!producers[@]}"; do
  p=${producers[$idx]}
  c=${consumers[$idx]}

  # ...and for each duration t...
  for t in "${durations[@]}"; do
    echo "TC #$tc â†’ duration=$t, producers=$p, consumers=$c"

    logfile="logser.txt"

    {
      echo "Test Case #$tc"
      echo "Duration:     $t"
      echo "Producers:    $p"
      echo "Consumers:    $c"
      echo "Started:      $(date '+%Y-%m-%d %H:%M:%S')"
      echo

      # Run your program under time, passing t, p, c
      /usr/bin/time -l -h -p \
        ./producer_consumer "$t" "$p" "$c"

      echo
      echo "Finished:     $(date '+%Y-%m-%d %H:%M:%S')"
    } &> "$logfile"

    # Increment test-case counter
    tc=$((tc + 1))
  done
done

echo "All tests done. Logs in logs/log_tc<index>_t<time>_p<producers>_c<consumers>.txt"
